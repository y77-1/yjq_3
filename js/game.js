// Èü≥È¢ëËÆæÁΩÆ
const ENABLE_AUDIO = true;  // ‰øùÊåÅÂêØÁî®Èü≥È¢ë

// Âè™‰øùÁïôËÉåÊôØÈü≥‰πê
const bgMusic = new Audio('data/audio/background.mp3');
bgMusic.loop = true;
bgMusic.volume = 0.3;

class Game {
    constructor() {
        this.playerInfo = this.loadPlayerInfo() || {
            id: this.generatePlayerId(),
            nickname: 'ÂÜíÈô©ËÄÖ',
            history: []
        };
        this.locations = [];
        this.initGame();
        
        // ÈªòËÆ§ÂêØÁî®Èü≥È¢ë
        this.soundEnabled = true;
        
        // Ê∑ªÂä†Èü≥È¢ëÈîôËØØÂ§ÑÁêÜ
        bgMusic.addEventListener('error', (e) => {
            console.warn('ËÉåÊôØÈü≥‰πêÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Á°Æ‰øùÊñá‰ª∂Â≠òÂú®:', e);
            this.soundEnabled = false;
        });

        this.currentTask = null;
        this.inventory = new Set();
        this.initInventoryUI();
    }

    async initGame() {
        try {
            // ‰øÆÊîπÊï∞ÊçÆÊñá‰ª∂Ë∑ØÂæÑ
            const response = await fetch('data/locations.txt')
                .catch(async () => {
                    console.error('Êó†Ê≥ïÂä†ËΩΩ locations.txt');
                    throw new Error('Êó†Ê≥ïÂä†ËΩΩÊ∏∏ÊàèÊï∞ÊçÆÔºåËØ∑Á°Æ‰øùÊñá‰ª∂Ë∑ØÂæÑÊ≠£Á°Æ');
                });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.text();
            
            // Ê£ÄÊü•Êï∞ÊçÆÊòØÂê¶‰∏∫Á©∫
            if (!data.trim()) {
                throw new Error('locations.txt Êñá‰ª∂‰∏∫Á©∫');
            }

            // Ëß£ÊûêÊï∞ÊçÆ
            try {
                this.locations = this.parseLocationData(data);
                if (!this.locations.length) {
                    throw new Error('Ê≤°ÊúâÂèØÁî®ÁöÑ‰ΩçÁΩÆÊï∞ÊçÆ');
                }
            } catch (parseError) {
                console.error('Êï∞ÊçÆËß£ÊûêÂ§±Ë¥•:', parseError);
                throw new Error('‰ΩçÁΩÆÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°Æ');
            }

            // Ê∏≤Êüì‰ΩçÁΩÆ
            this.renderLocations();
            
            // ÁßªÈô§Ëá™Âä®Êí≠ÊîæÂ∞ùËØïÔºåÊîπ‰∏∫ÊòæÁ§∫ÊèêÁ§∫
            if (ENABLE_AUDIO && bgMusic) {
                this.showMessage('ÁÇπÂáªÊí≠ÊîæÊåâÈíÆÂºÄÂßãËÉåÊôØÈü≥‰πê', 3000);
            }
        } catch (error) {
            console.error('Ê∏∏ÊàèÂàùÂßãÂåñÂ§±Ë¥•:', error);
            this.showMessage(`Ê∏∏ÊàèÂä†ËΩΩÂ§±Ë¥•: ${error.message}`, 5000);
            
            const retryButton = document.createElement('button');
            retryButton.className = 'retry-button';
            retryButton.textContent = 'ÈáçËØï';
            retryButton.onclick = () => {
                location.reload();
            };
            document.getElementById('game-container').appendChild(retryButton);
        }
    }

    parseLocationData(data) {
        try {
            return data.split('\n').filter(line => line.trim()).map(line => {
                const parts = line.split('|');
                if (parts.length < 6) {
                    throw new Error(`Êï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°Æ: ${line}`);
                }
                const [name, description, hint, isAccessible, action, taskHint] = parts;
                return {
                    name,
                    description,
                    hint,
                    isAccessible: isAccessible === 'true',
                    action,
                    taskHint
                };
            });
        } catch (error) {
            console.error('Ëß£ÊûêÊï∞ÊçÆÂ§±Ë¥•:', error);
            throw error;
        }
    }

    renderLocations() {
        const gameContainer = document.getElementById('game-container');
        gameContainer.innerHTML = this.locations
            .map(location => `
                <div class="location ${location.isAccessible ? 'accessible' : 'locked'}"
                     onclick="game.handleLocationClick(${JSON.stringify(location).replace(/"/g, '&quot;')})">
                    <h3>${this.escapeHtml(location.name)}</h3>
                    <p>${this.escapeHtml(location.description)}</p>
                    <p class="hint">${this.escapeHtml(location.hint)}</p>
                    ${location.isAccessible ? 
                        `<p class="task-hint">${this.escapeHtml(location.taskHint)}</p>` : 
                        '<p class="locked-message">üîí ÊöÇÊú™Ëß£ÈîÅ</p>'}
                    ${this.getLocationStatus(location)}
                </div>
            `).join('');
    }

    generatePlayerId() {
        return 'player_' + Math.random().toString(36).substr(2, 9);
    }

    loadPlayerInfo() {
        const savedInfo = localStorage.getItem('playerInfo');
        if (savedInfo) {
            const info = JSON.parse(savedInfo);
            // ÊÅ¢Â§çËÉåÂåÖÁâ©ÂìÅ
            if (info.inventory) {
                this.inventory = new Set(info.inventory);
            }
            return info;
        }
        return null;
    }

    savePlayerInfo() {
        const playerData = {
            ...this.playerInfo,
            inventory: Array.from(this.inventory) // Â∞Ü Set ËΩ¨Êç¢‰∏∫Êï∞ÁªÑ‰øùÂ≠ò
        };
        localStorage.setItem('playerInfo', JSON.stringify(playerData));
    }

    addToHistory(action) {
        this.playerInfo.history.push({
            action,
            timestamp: new Date().toISOString()
        });
        this.savePlayerInfo();
    }

    toggleMusic() {
        if (!this.soundEnabled) {
            this.showMessage('Èü≥È¢ëÂäüËÉΩÊú™ÂêØÁî®ÔºåËØ∑Á°Æ‰øùÈü≥È¢ëÊñá‰ª∂Â≠òÂú®');
            return;
        }

        try {
            if (bgMusic.paused) {
                bgMusic.play().then(() => {
                    this.showMessage('Èü≥‰πêÂ∑≤ÂºÄÂêØ');
                }).catch(e => {
                    console.warn('Êí≠ÊîæÂ§±Ë¥•:', e);
                    this.showMessage('ÁÇπÂáªÊí≠ÊîæÊåâÈíÆÊù•ÂêØÁî®Èü≥‰πê');
                });
            } else {
                bgMusic.pause();
                this.showMessage('Èü≥‰πêÂ∑≤ÊöÇÂÅú');
            }
        } catch (error) {
            console.warn('Èü≥‰πêÊéßÂà∂Â§±Ë¥•:', error);
        }
    }

    async handleLocationClick(location) {
        if (!location.isAccessible) {
            this.showMessage('Ëøô‰∏™Âú∞ÁÇπÊöÇÊó∂Êó†Ê≥ïËÆøÈóÆÔºÅ');
            return;
        }

        if (!location.action || typeof this[location.action] !== 'function') {
            console.error(`Êú™ÊâæÂà∞Âä®‰ΩúÂ§ÑÁêÜÊñπÊ≥ï: ${location.action}`);
            this.showMessage('ËØ•‰ΩçÁΩÆÊöÇÊó∂Êó†Ê≥ï‰∫íÂä®ÔºÅ');
            return;
        }

        try {
            const result = await this[location.action](location);
            if (result) {
                this.addToHistory(`Âú®${location.name}ÂÆåÊàê‰∫Ü‰ªªÂä°Ôºö${result}`);
                this.updateLocations(location);
            }
        } catch (error) {
            console.error('‰ªªÂä°ÊâßË°åÂ§±Ë¥•:', error);
            this.showMessage('‰ªªÂä°Â§±Ë¥•ÔºåËØ∑ÈáçËØïÔºÅ');
        }
    }

    async findBook() {
        const result = await this.showPuzzle('‰π¶Êû∂ÂØÜÁ†Å', 
            'ÊâæÂà∞‰∏Ä‰∏™ÂÜôÁùÄÊï∞Â≠óÁöÑÁ∫∏Êù°Ôºö1-3-5ÔºåËøôÂèØËÉΩÊòØÊâìÂºÄ‰π¶Êû∂ÁöÑÂØÜÁ†Å...',
            async (answer) => answer === '135'
        );
        
        if (result) {
            this.addToInventory('Âè§Á±ç');
            this.showMessage('‰Ω†ÊâæÂà∞‰∫Ü‰∏ÄÊú¨Á•ûÁßòÁöÑÂè§Á±çÔºÅ‰π¶‰∏≠ËÆ∞ËΩΩÁùÄÂÖ≥‰∫éÁ•ûÂ∫ôÁöÑÁßòÂØÜ...', 3000);
            return 'ÊâæÂà∞Âè§Á±ç';
        }
    }

    async solvePuzzle() {
        if (!this.inventory.has('Âè§Á±ç')) {
            this.showMessage('ÈúÄË¶ÅÂÖàÂú®Âõæ‰π¶È¶ÜÊâæÂà∞Âè§Á±çÔºÅ');
            return;
        }

        const result = await this.showPuzzle('Á¨¶ÊñáË∞úÈ¢ò',
            'Âè§Á±ç‰∏äËÆ∞ËΩΩÔºö‰∏úÂçóË•øÂåóÔºå‰æùÊ¨°ÁÇπ‰∫ÆÁ¨¶Êñá„ÄÇÊèêÁ§∫ÔºöÁî®Ëã±ÊñáÂ≠óÊØç E„ÄÅN„ÄÅS„ÄÅW Ë°®Á§∫ÊñπÂêë...',
            async (answer) => answer.toLowerCase() === 'ensw'
        );

        if (result) {
            this.addToInventory('Á¨¶ÊñáÈí•Âåô');
            this.showMessage('Á¨¶ÊñáÂèëÂá∫ËÄÄÁúºÁöÑÂÖâËäíÔºå‰Ω†Ëé∑Âæó‰∫ÜÁ¨¶ÊñáÈí•ÂåôÔºÅ', 3000);
            return 'Ëß£ÂºÄÁ¨¶ÊñáË∞úÈ¢ò';
        }
    }

    async negotiateGuard() {
        if (!this.inventory.has('Á¨¶ÊñáÈí•Âåô')) {
            this.showMessage('ÂÆàÂç´Êã¶‰Ωè‰∫Ü‰Ω†ÔºöÊ≤°ÊúâÁ¨¶ÊñáÈí•ÂåôÔºå‰∏çËÉΩÈÄöËøáÔºÅ');
            return;
        }

        await this.showProgress('Ê≠£Âú®‰∏éÂÆàÂç´‰∫§Ê∂â...', 3000);
        this.addToInventory('ÈÄöË°åËØÅ');
        this.showMessage('ÂÆàÂç´ÁúãÂà∞Á¨¶ÊñáÈí•ÂåôÔºåÊÅ≠Êï¨Âú∞‰∏∫‰Ω†ËÆ©ÂºÄ‰∫ÜÈÅìË∑Ø„ÄÇ', 3000);
        return 'Ëé∑ÂæóÂÆàÂç´ÁöÑ‰ø°‰ªª';
    }

    async searchTreasure() {
        if (!this.inventory.has('ÈÄöË°åËØÅ')) {
            this.showMessage('Ê≤°ÊúâÈÄöË°åËØÅÔºåÊó†Ê≥ïËøõÂÖ•ÂØÜÂÆ§ÔºÅ');
            return;
        }

        await this.showProgress('Ê≠£Âú®ÊêúÁ¥¢ÂÆùËóè...', 5000);
        const treasureTypes = ['ÈáëÂ∏Å', 'ÂÆùÁü≥', 'Âè§ËÄÅÂç∑ËΩ¥', 'Á•ûÁßòÊ≥ïÂô®'];
        const randomTreasure = treasureTypes[Math.floor(Math.random() * treasureTypes.length)];
        this.addToInventory(randomTreasure);
        this.showMessage(`ÊÅ≠ÂñúÔºÅ‰Ω†ÊâæÂà∞‰∫Ü‰º†ËØ¥‰∏≠ÁöÑÂÆùËóèÔºö${randomTreasure}ÔºÅ`, 5000);
        return `ÊâæÂà∞ÂÆùËóèÔºö${randomTreasure}`;
    }

    showMessage(text, duration = 3000) {
        const dialog = document.createElement('div');
        dialog.className = 'dialog-box';
        dialog.textContent = text;
        document.body.appendChild(dialog);
        setTimeout(() => dialog.remove(), duration);
    }

    async showPuzzle(title, hint, validateFn) {
        return new Promise((resolve) => {
            const dialog = document.createElement('div');
            dialog.className = 'dialog-box';
            dialog.innerHTML = `
                <h3>${title}</h3>
                <p>${hint}</p>
                <input type="text" placeholder="ËæìÂÖ•Á≠îÊ°à">
                <button>Á°ÆËÆ§</button>
            `;
            
            const input = dialog.querySelector('input');
            const button = dialog.querySelector('button');
            
            const checkAnswer = async () => {
                if (await validateFn(input.value)) {
                    dialog.remove();
                    resolve(true);
                } else {
                    this.showMessage('Á≠îÊ°à‰∏çÊ≠£Á°ÆÔºåËØ∑ÈáçËØïÔºÅ');
                }
            };
            
            // Ê∑ªÂä†ÂõûËΩ¶ÈîÆÊîØÊåÅ
            input.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter') {
                    await checkAnswer();
                }
            });
            
            button.onclick = checkAnswer;
            
            document.body.appendChild(dialog);
            input.focus(); // Ëá™Âä®ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
        });
    }

    async showProgress(text, duration) {
        return new Promise((resolve) => {
            const dialog = document.createElement('div');
            dialog.className = 'dialog-box';
            dialog.innerHTML = `
                <p>${text}</p>
                <div class="progress-bar">
                    <div class="progress-bar-fill" style="width: 0%"></div>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            const fill = dialog.querySelector('.progress-bar-fill');
            const startTime = Date.now();
            
            const updateProgress = () => {
                const elapsed = Date.now() - startTime;
                const progress = (elapsed / duration) * 100;
                
                if (progress < 100) {
                    fill.style.width = `${progress}%`;
                    requestAnimationFrame(updateProgress);
                } else {
                    dialog.remove();
                    resolve();
                }
            };
            
            requestAnimationFrame(updateProgress);
        });
    }

    updateLocations(completedLocation) {
        // Ê†πÊçÆÂÆåÊàêÁöÑ‰ªªÂä°Êõ¥Êñ∞ÂÖ∂‰ªñ‰ΩçÁΩÆÁöÑÂèØËÆøÈóÆÁä∂ÊÄÅ
        if (completedLocation.name === 'Âõæ‰π¶È¶Ü') {
            this.locations.find(l => l.name === 'Á•ûÂ∫ô').isAccessible = true;
        } else if (completedLocation.name === 'Á•ûÂ∫ô') {
            this.locations.find(l => l.name === 'ÂÆàÂç´Ëê•Âú∞').isAccessible = true;
        } else if (completedLocation.name === 'ÂÆàÂç´Ëê•Âú∞') {
            this.locations.find(l => l.name === 'ÂØÜÂÆ§').isAccessible = true;
        }
        
        this.renderLocations();
        this.savePlayerInfo();  // ‰øùÂ≠òÊ∏∏ÊàèÁä∂ÊÄÅ
    }

    // Ê∑ªÂä† HTML ËΩ¨‰πâÊñπÊ≥ï
    escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    initInventoryUI() {
        const inventoryDiv = document.createElement('div');
        inventoryDiv.id = 'inventory';
        inventoryDiv.className = 'inventory-container';
        document.body.appendChild(inventoryDiv);
        this.updateInventoryUI();
    }

    updateInventoryUI() {
        const inventoryDiv = document.getElementById('inventory');
        inventoryDiv.innerHTML = `
            <h3>ËÉåÂåÖÁâ©ÂìÅ</h3>
            <div class="inventory-items">
                ${Array.from(this.inventory).map(item => `
                    <div class="inventory-item">${this.escapeHtml(item)}</div>
                `).join('') || '<p>ËÉåÂåÖÊòØÁ©∫ÁöÑ</p>'}
            </div>
        `;
    }

    addToInventory(item) {
        this.inventory.add(item);
        this.updateInventoryUI();
        this.savePlayerInfo();
    }

    getLocationStatus(location) {
        if (location.name === 'Âõæ‰π¶È¶Ü' && this.inventory.has('Âè§Á±ç')) {
            return '<p class="completed">‚úÖ Â∑≤ÊâæÂà∞Âè§Á±ç</p>';
        }
        if (location.name === 'Á•ûÂ∫ô' && this.inventory.has('Á¨¶ÊñáÈí•Âåô')) {
            return '<p class="completed">‚úÖ Â∑≤Ëß£ÂºÄÁ¨¶Êñá</p>';
        }
        if (location.name === 'ÂÆàÂç´Ëê•Âú∞' && this.inventory.has('ÈÄöË°åËØÅ')) {
            return '<p class="completed">‚úÖ Â∑≤Ëé∑ÂæóÈÄöË°åËØÅ</p>';
        }
        return '';
    }
}

// ÂàõÂª∫ÂÖ®Â±ÄÊ∏∏ÊàèÂÆû‰æã
window.game = new Game(); 

// ÁßªÈô§È°µÈù¢ÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÂè™‰øùÁïôÊ∏∏ÊàèÂÆû‰æãÂàõÂª∫
window.game = new Game();

// ÁßªÈô§ DOMContentLoaded ‰∫ã‰ª∂ÁõëÂê¨Âô®‰∏≠ÁöÑÈü≥È¢ëÁõ∏ÂÖ≥‰ª£Á†Å
document.addEventListener('DOMContentLoaded', () => {
    const playerDetails = document.getElementById('player-details');
    playerDetails.innerHTML = `
        <p>ID: ${game.playerInfo.id}</p>
        <p>ÊòµÁß∞: ${game.playerInfo.nickname}</p>
    `;
    
    function updateHistory() {
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = game.playerInfo.history
            .map(h => `<div>${new Date(h.timestamp).toLocaleString()} - ${h.action}</div>`)
            .join('');
    }
    updateHistory();
}); 